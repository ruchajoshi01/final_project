---
title: "The Office"
author: "Rucha Joshi"
date: "12/2/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(tidyverse)
library(tidytext)
library(googlesheets4)
library(RCurl)
library(SentimentAnalysis)
library(janitor)
```


```{r}
# Read in and clean data
sheets_deauth()
clean_data <- read_sheet("13ZZfByyxT2hznhdALJtQqbslW6VYERlJsRbumOQuTYA") %>%
    filter(deleted == "FALSE") %>%
    mutate(actions = str_extract_all(line_text, "\\[.*?\\]"),
           line_text_mod = str_trim(str_replace_all(line_text, "\\[.*?\\]", ""))) %>% 
    mutate_at(vars(line_text_mod), funs(str_replace_all(., "���","'"))) %>% 
    mutate_at(vars(speaker), funs(tolower)) %>% 
    mutate_at(vars(speaker), funs(str_trim(str_replace_all(., "\\[.*?\\]", "")))) %>% 
    mutate_at(vars(speaker), funs(str_replace_all(., "micheal|michel|michae$", "michael")))

clean_data_df <- as.data.frame(clean_data)
write_rds(clean_data_df, "./the-office/clean_data.rds")

# Plot number of lines spoken by each character in season 1
plot1 <- clean_data %>%
  select(season, episode, speaker) %>%
  filter(season == "1", speaker == c("toby", "stanley", "ryan", "roy", 
                                    "phyllis", "pam", "oscar", "michael", 
                                    "dwight", "meredith", "kevin", "jim", 
                                    "jan", "angela", "darryl")) %>% 
  ggplot(aes(x = speaker)) +
  geom_bar() +
  labs(title = "Number of lines spoken by each character in season 1", 
       x = "Character", 
       y = "Number of lines") +
  coord_flip()

# Plot number of episodes each character is in per season
plot2 <- clean_data %>%
  select(season, episode, speaker) %>%
  filter(season == "1", speaker == c("toby", "stanley", "ryan", "roy", 
                                    "phyllis", "pam", "oscar", "michael", 
                                    "dwight", "meredith", "kevin", "jim", 
                                    "jan", "angela", "darryl")) %>% 
  count(episode, speaker) %>%
  ggplot(aes(x = speaker)) +
  geom_bar() +
  labs(title = "Number of episodes acted by each character in season 1", 
       x = "Character", 
       y = "Number of episodes") +
  coord_flip()

plot3 <- clean_data %>%
  select(season, speaker, scene) %>%
  filter(season == "1", speaker == c("toby", "stanley", "ryan", "roy", 
                                    "phyllis", "pam", "oscar", "michael", 
                                    "dwight", "meredith", "kevin", "jim", 
                                    "jan", "angela", "darryl")) %>% 
  count(scene, speaker) %>%
  ggplot(aes(x = speaker)) +
  geom_bar() +
  labs(title = "Number of scenes acted by each character in season 1", 
       x = "Character", 
       y = "Number of scenes") +
  coord_flip()

```


```{r}
tidy_tokens <- clean_data %>%
  select(line = id, line_text_mod, everything(), -line_text, -actions, -deleted) %>% 
  unnest_tokens(word, line_text_mod, strip_numeric = TRUE) %>%
  mutate_at(vars(word), funs(str_replace_all(., "'s$", ""))) %>%
  anti_join(stop_words, by = "word")

custom_stop_words <- bind_rows(data_frame(word = c("yeah", "hey", "uh", "um", "huh", "hmm", "ah", "umm", "uhh", "gonna", "na", "ha", "gotta"), 
                                          lexicon = c("custom")), 
                               stop_words)

tidy_tokens_no_stop <- tidy_tokens %>% 
  anti_join(custom_stop_words, by = "word") %>%
  #filter(speaker == "michael") %>%
  filter(season == 1) %>%
  count(speaker, word) %>%
  arrange(desc(n)) %>%
  mutate(prop = round((n / sum(n))*100, 1)) %>%
  head(10)

ggplot(tidy_tokens_no_stop, aes(x = reorder(word, prop), y = prop)) + 
  geom_col() +
  coord_flip() +
  labs(title = "word frequencies: Michael",
       y = "Percentages",
       x = "")

tidy_tokens_tf_idf <- tidy_tokens %>%
  count(speaker, word, sort = TRUE) %>%
  ungroup() %>% 
  filter(speaker %in% c("toby", "stanley", "ryan", "roy", 
                                    "phyllis", "pam", "oscar", "michael", 
                                    "dwight", "meredith", "kevin", "jim", 
                                    "jan", "angela", "darryl")) %>% 
  bind_tf_idf(word, speaker, n) %>%
  arrange(desc(tf_idf)) %>%
  rename(prop = tf_idf) %>%
  filter(speaker == "michael") %>%
  head(10)

ggplot(tidy_tokens_tf_idf, aes(x = reorder(word, prop), y = prop)) +
  geom_col() +
  coord_flip() +
  labs(title = "word frequencies: Michael",
       y = "Percentages",
       x = "")







nrc_joy <- get_sentiments("nrc") #%>% 
  #filter(sentiment == "fear")

michael_lines_1 <- clean_data %>%
  filter(speaker == "michael") %>%
  filter(season == 1) %>%
  select(line = id, line_text_mod, everything(), -line_text, -actions, -deleted) %>% 
  unnest_tokens(word, line_text_mod, strip_numeric = TRUE) %>%
  mutate_at(vars(word), funs(str_replace_all(., "'s$", ""))) %>%
  inner_join(nrc_joy) %>%
  group_by(sentiment) %>%
  count(sentiment, sort = TRUE)
  #rowid_to_column("id")
  #summarise(word_count = n())

#michael_lines_2 <- tibble(michael_lines_1$sentiment, michael_lines_1$n, id = 1:10)
#unnest(michael_lines_1) 
label_data = michael_lines_1
number_of_bar = nrow(label_data) #Calculate the ANGLE of the labels
angle = 90 - 360 * (label_data$id - 0.5) / number_of_bar #Center things
label_data$hjust <- ifelse(angle < -90, 1, 0) #Align label
label_data$angle <- ifelse(angle < -90, angle + 180, angle) #Flip angle


bar_plot <- ggplot(michael_lines_1, aes(x = "", y = n, fill = sentiment)) + 
  geom_bar(width = 1, stat = "identity") + 
  labs(x = "number",
       y = "sentiment")

pie <- bar_plot + coord_polar("y", start=0)

bing <- get_sentiments("bing")

bing_analysis <- clean_data %>%
  filter(speaker == "angela") %>%
  filter(season == 9) %>%
  select(line = id, line_text_mod, everything(), -line_text, -actions, -deleted) %>% 
  unnest_tokens(word, line_text_mod, strip_numeric = TRUE) %>%
  mutate_at(vars(word), funs(str_replace_all(., "'s$", ""))) %>%
  group_by(episode, speaker) %>%
  inner_join(bing) %>%
 # group_by(sentiment) %>%
  count(sentiment, sort = TRUE)

line_bing <- bing_analysis %>%
  ggplot(aes(x = episode, y = n, group = sentiment, color = sentiment)) +
  geom_line()


afinn <- get_sentiments("afinn")

afinn_analysis <- clean_data %>%
  filter(speaker == "stanley") %>%
  filter(season == 2) %>%
  select(line = id, line_text_mod, everything(), -line_text, -actions, -deleted) %>% 
  unnest_tokens(word, line_text_mod, strip_numeric = TRUE) %>%
  mutate_at(vars(word), funs(str_replace_all(., "'s$", ""))) %>%
  group_by(episode, speaker) %>%
  inner_join(afinn) %>%
 # group_by(sentiment) %>%
  count(value, sort = TRUE)

line_afinn <- afinn_analysis %>%
  ggplot(aes(x = episode, y = value, group = value, color = value)) +
  geom_point()

```


